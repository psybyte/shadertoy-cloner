name: Build and Release Installer

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-installer:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
      # ── Checkout ─────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Node.js ──────────────────────────────────────────────────────────────
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install @yao-pkg/pkg
        run: npm install --save-dev @yao-pkg/pkg

      # ── Build standalone exe ─────────────────────────────────────────────────
      - name: Build standalone server executable
        run: npx pkg server.js --targets node20-win-x64 --assets "public/**/*" --output dist/shadertoy-cloner.exe

      # ── Get NSSM (service wrapper) ────────────────────────────────────────────
      - name: Get NSSM binary
        shell: pwsh
        run: |
          choco install nssm --no-progress -y
          # Chocolatey extracts the real binary under lib\NSSM\tools\
          $nssmExe = "$env:ChocolateyInstall\lib\NSSM\tools\nssm.exe"
          if (-not (Test-Path $nssmExe)) {
            # Fallback: search the lib folder recursively
            $nssmExe = Get-ChildItem "$env:ChocolateyInstall\lib\NSSM" -Recurse -Filter "nssm.exe" |
                       Where-Object { $_.Directory.Name -eq "win64" -or $_.Directory.Name -eq "tools" } |
                       Select-Object -First 1 -ExpandProperty FullName
          }
          if (-not $nssmExe -or -not (Test-Path $nssmExe)) {
            Write-Error "Could not locate nssm.exe after Chocolatey install"
            Get-ChildItem "$env:ChocolateyInstall\lib\NSSM" -Recurse | Select-Object FullName
            exit 1
          }
          Copy-Item $nssmExe -Destination "installer\nssm.exe"
          Write-Host "NSSM copied from $nssmExe"

      # ── Extract version from tag ──────────────────────────────────────────────
      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $tag = $env:GITHUB_REF_NAME          # e.g. v1.2.3
          $ver = $tag -replace '^v', ''         # e.g. 1.2.3
          echo "VERSION=$ver" >> $env:GITHUB_OUTPUT
          echo "TAG=$tag"     >> $env:GITHUB_OUTPUT
          Write-Host "Building version: $ver"

      # ── Build NSIS installer ──────────────────────────────────────────────────
      - name: Install NSIS
        shell: pwsh
        run: choco install nsis --no-progress -y

      - name: Build NSIS installer
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          # Chocolatey does not refresh PATH in the same shell session;
          # use the known NSIS install path directly.
          $makensis = "$env:ProgramFiles(x86)\NSIS\makensis.exe"
          if (-not (Test-Path $makensis)) {
            $makensis = "$env:ProgramFiles\NSIS\makensis.exe"
          }
          if (-not (Test-Path $makensis)) {
            Write-Error "makensis.exe not found. Searched: $env:ProgramFiles(x86)\NSIS and $env:ProgramFiles\NSIS"
            exit 1
          }
          & $makensis /DVERSION=$version installer\installer.nsi
          Write-Host "Installer built: dist\ShaderToy-Cloner-Setup-$version.exe"

      # ── Verify output ─────────────────────────────────────────────────────────
      - name: Verify build output
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $installer = "dist\ShaderToy-Cloner-Setup-$version.exe"
          if (Test-Path $installer) {
            $size = (Get-Item $installer).Length / 1MB
            Write-Host "✓ Installer ready: $installer ($([math]::Round($size,1)) MB)"
          } else {
            Write-Error "✗ Installer not found: $installer"
            exit 1
          }

      # ── Create GitHub Release ─────────────────────────────────────────────────
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: "ShaderToy Cloner ${{ steps.version.outputs.TAG }}"
          body: |
            ## ShaderToy Cloner ${{ steps.version.outputs.TAG }}

            ### Installation
            1. Download `ShaderToy-Cloner-Setup-${{ steps.version.outputs.VERSION }}.exe`
            2. Run it as Administrator
            3. Follow the setup wizard
            4. The server starts automatically as a Windows service on port **7700**
            5. Open **http://localhost:7700** to manage your shaders

            ### What gets installed
            - Windows service that starts automatically with Windows
            - Start Menu and Desktop shortcuts to open the web interface
            - Uninstaller registered in *Add or Remove Programs*

            ### Uninstall
            Use *Add or Remove Programs* → *ShaderToy Cloner* → Uninstall.
            Your cloned shaders in the `data\` folder are preserved.

            ### Requirements
            - Windows 10 / 11 (x64)
            - No additional software needed — Node.js is bundled
          generate_release_notes: false
          draft: false
          prerelease: false
          files: |
            dist/ShaderToy-Cloner-Setup-${{ steps.version.outputs.VERSION }}.exe
