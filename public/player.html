<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ShaderToy Player</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #000; }
    #c { display: block; width: 100%; height: 100%; }

    #overlay {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      background: rgba(0,0,0,0.85);
      color: #fff;
      font-family: system-ui, sans-serif;
      z-index: 10;
      pointer-events: none;
    }
    #overlay.hidden { display: none; }
    #overlay-icon { font-size: 2.5rem; }
    #overlay-msg { font-size: 1rem; max-width: 400px; text-align: center; opacity: .85; }
    #overlay-detail {
      font-size: .78rem;
      max-width: 440px;
      text-align: center;
      opacity: .55;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }

    #fps {
      position: fixed;
      top: 8px;
      right: 12px;
      font-family: monospace;
      font-size: 11px;
      color: rgba(255,255,255,.35);
      pointer-events: none;
      user-select: none;
      z-index: 5;
      transition: opacity 3s;
    }
    #fps.fade { opacity: 0; }
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <div id="fps">-- fps</div>

  <div id="overlay">
    <div id="overlay-icon">⬡</div>
    <div id="overlay-msg">Cargando shader…</div>
    <div id="overlay-detail"></div>
  </div>

  <script src="/js/renderer.js"></script>
  <script>
    (async () => {
      const canvas  = document.getElementById('c');
      const overlay = document.getElementById('overlay');
      const overlayMsg    = document.getElementById('overlay-msg');
      const overlayDetail = document.getElementById('overlay-detail');
      const fpsEl   = document.getElementById('fps');

      const shaderId = location.pathname.split('/').pop();
      if (!shaderId) {
        overlayMsg.textContent = 'ID de shader no especificado';
        return;
      }

      let shaderData;
      try {
        const res = await fetch(`/api/shaders/${shaderId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        shaderData = await res.json();
      } catch (err) {
        overlayMsg.textContent = 'No se encontró el shader';
        overlayDetail.textContent = err.message;
        return;
      }

      const info = shaderData.Shader.info;
      document.title = info.name || 'ShaderToy Player';

      let renderer;
      try {
        renderer = new ShaderRenderer(canvas);
        await renderer.load(shaderData);
      } catch (err) {
        overlayMsg.textContent = 'Error al compilar el shader';
        overlayDetail.textContent = err.message;
        console.error(err);
        return;
      }

      overlay.classList.add('hidden');

      // FPS counter — fades after 5 s
      let frames = 0, lastFpsTime = performance.now();
      setTimeout(() => fpsEl.classList.add('fade'), 5000);

      function loop() {
        renderer.render();
        frames++;
        const now = performance.now();
        if (now - lastFpsTime >= 1000) {
          fpsEl.textContent = `${frames} fps`;
          frames = 0;
          lastFpsTime = now;
        }
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);
    })();
  </script>
</body>
</html>
